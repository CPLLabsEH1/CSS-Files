//custom icons
var BarcodeIconData = "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000005e000000b6000000c2000000870000000f000000c800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000a60000008d000000230000000d00000059000000ca000000cc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e0000008d000000000000000000000036000000cc000000e8000000cc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b70000002300000000000000000000000000000000000000000000000f000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c4000000110000000000000000000000000000000000000000000000a70000002700000000000000cc00000033000000ff00000033000000ff000000ff000000ff00000033000000990000003b0000008f00000054000000000000000000000000000000000000000a000000d40000000500000000000000cc00000033000000ff00000033000000ff000000ff000000ff00000033000000990000008b00000035000000d20000002e00000000000000000000000a000000a40000006d0000000000000000000000cc00000033000000ff00000033000000ff000000ff000000ff0000003300000099000000990000008e00000026000000bd000000be000000aa000000d50000006d000000000000000000000000000000cc00000033000000ff00000033000000ff000000ff000000ff000000330000009900000099000000990000007100000019000000330000002b0000002e00000015000000000000000000000000000000cc00000033000000ff00000033000000ff000000ff000000ff000000330000009900000099000000990000009900000033000000ff000000990000009900000033000000000000000000000000000000cc00000033000000ff00000033000000ff000000ff000000ff000000330000009900000099000000990000009900000033000000ff000000990000009900000033000000000000000000000000000000cc00000033000000ff00000033000000ff000000ff000000ff000000330000009900000099000000990000009900000033000000ff000000990000009900000033000000000000000000000000000000cc00000033000000ff00000033000000ff000000ff000000ff000000330000009900000099000000990000009900000033000000ff000000990000009900000033000000000000000000000000000000cc00000033000000ff00000033000000ff000000ff000000ff000000330000009900000099000000990000009900000033000000ff000000990000009900000033000000000000000000000000000000cc00000033000000ff00000033000000ff000000ff000000ff000000330000009900000099000000990000009900000033000000ff000000990000009900000033000000000000000000000000000000cc00000033000000ff00000033000000ff000000ff000000ff000000330000009900000099000000990000009900000033000000ff000000990000009900000033000000000000000000000000000000cc00000033000000ff00000033000000ff000000ff000000ff000000330000009900000099000000990000009900000033000000ff000000990000009900000033000000000000000000000000000000a300000029000000cc00000029000000cc000000cc000000cc000000290000007b0000007b0000007b0000007b00000029000000cc0000007b0000007b0000002900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"

var BarcodeIcon = {count: 0,width: 20,height: 20, read: function(nBytes){return BarcodeIconData.slice(this.count, this.count += nBytes);}};

// barcode scripts
var Barcode = app.trustedFunction(function()
{
// opens Accession entry box
var Acc = app.response({cTitle:"Accession"});

// gets field coordinates to place box always top right corner
var aRect=this.getPageBox();
var width = aRect[2] - aRect[0];
var height = aRect[1] - aRect[3];
var AFdL = width - 165;
var AFdT = height - 52;
var AFdR = width - 42;
var AFdB = height - 72;
var BFdL = width - 165;
var BFdT = height - 17;
var BFdR = width - 42;
var BFdB = height - 57;

// creates fields for barcode and accession
for (var p=0; p<this.numPages; p++){
//    var AFd = this.addField({cName:"TheNumber", cFieldType:"text", nPageNum:p, oCoords:[447,740,570,720]});
    var AFd = this.addField({cName:"TheNumber", cFieldType:"text", nPageNum:p, oCoords:[AFdL,AFdT,AFdR,AFdB]});
    AFd.readonly = true;
    AFd.textSize=0;
    AFd.textFont = "Helvetica-Bold";
    AFd.fillColor = color.white;
    AFd.alignment = "center";
//    var BFd = this.addField({cName:"TheAccession", cFieldType:"text", nPageNum:p, oCoords:[447,775,570,735]});
    var BFd = this.addField({cName:"TheAccession", cFieldType:"text", nPageNum:p, oCoords:[BFdL,BFdT,BFdR,BFdB]});
    BFd.readonly = true;
    BFd.textSize=0
    BFd.textFont = "Free3of9";
    BFd.fillColor = color.white;
}

// this will populate the fields
this.getField("TheNumber").value = Acc;
if(this.getField("TheNumber").value = Acc){
    this.getField("TheAccession").value = "*"+Acc+"*";
}else{
    this.getField("TheAccession").value = "";
//    this.removeField("TheAccession");
//   this.removeField("TheNumber");	
}

// validation checks
var myRegExp = /^([A-Za-z]{1}\d{7,8}|[A-Za-z]{2}\d{6,7})$/;
var myTextInput = Acc;
event.rc = true;
if ( !myRegExp.test(myTextInput) && event.value != "")
{
    app.alert("Invalid Accession.");
    event.rc = false;
//    this.resetForm(["TheNumber","TheAccession"]);
    this.removeField("TheAccession");
    this.removeField("TheNumber");	    
}
});

var getName = app.trustedFunction(function() 
{
    //Get and return the user's login name
    app.beginPriv();
    return identity.name;
    app.EndPriv();
});

// Add button to toolbar
app.addToolButton({
	cName: "mySaveAsButtonBarcode",
	cLabel: "Barcode",
	oIcon: BarcodeIcon,
	cEnable: "event.rc = (app.doc != null);", 
	cExec: "Barcode();" 
});