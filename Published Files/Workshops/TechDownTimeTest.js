//CUSTOM ICON DATA STREAM
var CustomerIconData = "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000724b6ff8031bdefd12fb9edd12db7ec7f2ab4ea062aaaff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a832bdeeff30baeeff2db7edff2bb4ebff29b1eaa626ade900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000262ebbf1ff30baeeff2db7edff2bb4ebff29b1eaff27aee9ff25abe82423aae90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004831bbedff2db7edff2bb4ebff29b1eaff27aee9ff25abe8ff23a8e74720a5e50000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001b2fb3ecfc2ab4eaff29b1eaff27aee9ff25abe8ff23a8e7fc21a4e41a1da6e1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008528b0e9ff27aee9ff25abe8ff23a8e7ff21a5e5831da3e30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005424aae6a523a8e6a520a5e4531ea2e3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000533ccff6a30bbeec830bbeef42fb8edf42db6edc72bb4eb682cb2eb053399ff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000001433bff2c730bcefff30bbeeff2fb9edff2eb7edff2cb5ecff2bb4ebff2ab2eac627b0ea1426b2e50000000000000000000000000000000000000000000000000000000000000000000000000100ffffc031bcefff30bbeeff2fb9edff2eb7edff2cb5ecff2bb4ebff2ab2eaff28b0eaff27aee9be25ade80100ffff00000000000000000000000000000000000000000000000000000000000000005331bbefff30bbeeff2fb9edff2eb7edff2cb5ecff2bb4ebff2ab2eaff28b0eaff27aee9ff26ade8ff25abe85122aae50000000000000000000000000000000000000000000000000000000000000000a830baeeff2fb9edff2eb7edff2cb5ecff2bb4ebff2ab2eaff28b0eaff27aee9ff26ade8ff25abe8ff23a9e7a621a7e60000000000000000000000000000000000000000000000000000000000000000cc2fb9edff2eb7edff2cb5ecff2bb4ebff2ab2eaff28b0eaff27aee9ff26ade8ff25abe8ff23a9e7ff22a7e6cb20a5e50000000000000000000000000000000000000000000000000000000000000000d42db6ecff2cb5ecff2bb4ebff2ab2eaff28b0eaff27aee9ff26ade8ff25abe8ff23a9e7ff22a7e6ff21a6e6d41fa3e400000000000000000000000000000000000000000000000000000000000000008f2cb5ebee2ab4eaee29b1e9ee27afe9ee26ade8ee25ace8ee25abe8ee23a9e7ee22a7e6ee21a6e6ee1fa3e58e1ea1e40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

var CustomerIcon = {count: 0,width: 20,height: 20, read: function(nBytes){return CustomerIconData.slice(this.count, this.count += nBytes);}};

var TechDownIconData = "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a6000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000a60000000000000000000000bf000000b30000006600000066000000660000006600000066000000660000006600000066000000660000006600000066000000660000006600000066000000b3000000bf0000000000000000000000bf00000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000bf0000000000000000000000bf00000080000000000000000000000000000000000000001400000055000000990000009500000000000000000000000000000000000000000000000000000080000000bf0000000000000000000000bf00000080000000050000004000000086000000cd000000fd000000ed000000f30000008700000000000000000000000000000000000000000000000000000085000000bf0000000000000000000000bf000000e1000000f3000000fb000000c50000007d0000003700000003000000e70000005c0000000000000000000000160000005600000098000000d9000000ff000000bf0000000000000000000000bf000000c3000000530000001000000000000000000000000000000012000000ff0000007a00000090000000d2000000fe000000f0000000b2000000700000009f000000bf0000000000000000000000bf0000008000000000000000000000000000000000000000000000003d000000ff000000f5000000bb000000800000004400000005000000000000000000000080000000bf0000000000000000000000bf000000800000000000000000000000000000000000000000000000260000003c0000000600000000000000000000000000000000000000000000000000000080000000bf0000000000000000000000bf00000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000bf0000000000000000000000bf000000ee000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000dd000000ee000000bf00000000000000000000004d00000066000000660000006600000066000000660000006600000066000000c6000000c6000000660000006600000066000000660000006600000066000000660000004d000000000000000000000000000000000000000000000000000000000000004d0000006600000066000000c6000000c600000066000000660000004d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a6000000dd000000dd000000dd000000dd000000dd000000dd000000a6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

var TechDownIcon = {count: 0,width: 20,height: 20, read: function(nBytes){return TechDownIconData.slice(this.count, this.count += nBytes);}};

//BASIC UNIVERSAL FUNCTIONS
//Returns users login intiails
var getLoginName = app.trustedFunction(
    function () {
         //Get and return the user's login name
        app.beginPriv();
        return identity.loginName;
        app.EndPriv();
    });

// Create Date & Time stamp for file names
function DownTimeDateString()
{
    return util.printd("yyyy.mm.dd - HH.MM.ss", new Date()).toUpperCase();
}


//THE START OF THE TWO FORMS CODING
// Function that checks for required fields and saves file
var TechDownTime = app.trustedFunction(function(){

    // File Name
    var DowntimeFileName = DownTimeDateString() + " " + getLoginName();

    if (this.getField("TechIssueFormv1") === null){

      var TechIssueAlert = app.alert ("You are using the incorrect form for this button \n\n" + "The correct Technical Issue Form will open from the Blank Forms Button",0,0);

      if (TechIssueAlert == 1){
        // this.closeDoc(true);
        app.openDoc("/uscplatxdfs001p/CLIENT/OPERATIONS/Customer Service/Resources/zFiles/Technical Issue Form.pdf");
      };  
    }else {

      //Check for required fields
      var emptyFields = new Array();
      for (var i = 0; i < this.numFields; i++){
        var rName = this.getNthFieldName(i);
        var rField = this.getField(rName);
        if (rField.type != "button" && this.getField(rName).required && (this.getField(rName).value == null || this.getField(rName).value == "" || this.getField(rName).valueAsString != "Yes" || this.getField(rName).valueAsString != "No"))
        {
            emptyFields[emptyFields.length] = rName;
        }
      }

      // Set required Fields as focus
      var errormsg = "Please complete the following required fields: \n\n";
      for (j = 0; j < emptyFields.length; j++){

        if (emptyFields[j].value == null)
        {
            errormsg = errormsg + emptyFields[j] + '\n';
            var rField2 = this.getField(emptyFields[j]);
            rField2.setFocus();
        }
      }

      // Sets the alert if required fields are needed else saves and closes file
      if (emptyFields.length > 0){
        app.alert(errormsg);
      }else{
        // Set up the app alert to submit file
        var nTechDT = app.alert("Submit Technical Issue Log?",2,2);

        if (nTechDT == 4){
             // Flatten the file
            this.flattenPages();

            // Save the file
            app.beginPriv();
            this.saveAs("/uscplatxdfs001p/CLIENT/OPERATIONS/Customer Service/Resources/0Downtime Log/" + DowntimeFileName + ".pdf");
            app.endPriv();

            // Closes the file
            this.closeDoc(true);
        }
      }
    }  
});

//This is the function for the time correction form 
var TimeCorrection = app.trustedFunction(function(){

  if (this.getField("TimeCorrectionFormv1") === null){

    var TechIssueAlert = app.alert ("You are using the incorrect form for this button \n\n" + "The correct Time Correction & Mileage Form will open from the Blank Forms Button",0,0);

    if (TechIssueAlert == 1){
      app.openDoc("/uscplatxdfs001p/CLIENT/OPERATIONS/Customer Service/Resources/zFiles/Time Correction and Mileage Request Form.pdf");
    };  
  }else {

    // Checks if a digital signature is made
    var isSigned = false;
    for (var i=0; i<this.numFields; i++) {
      var fname = this.getNthFieldName(i);
      var f = this.getField(fname);
      if (f==null) continue;
      if (f.type=="signature" && f.value!="") {isSigned = true; break;}
    }

    // Checks if the hidden checkbox is checked to help catch fill and sign signatures
    var isChecked = this.getField("HiddenSig").value;

    // Saving email variables
    var TimeCorName = this.getField("Name").value;
    var TimeCorEmail = "ATorres@cpllabs.com; DBaileySampson@cpllabs.com; eherrera@cpllabs.com; msandoval@cpllabs.com";
    var TimeCorSubject = "Time Correction " + TimeCorName;

    // Will send email to supervisors
    if (isSigned || isChecked === "Yes"){
      this.mailDoc({bUI: true, cTo: TimeCorEmail, cSubject: TimeCorSubject});
      this.closeDoc(true);
    }else {
    app.alert("Please SIGN the form");
    }
  }
});

//ADDING MENU AND SUBMENUS
app.addSubMenu({cName:"Submit CSR Forms", cParent:"File", nPos:2});
app.addMenuItem({cName:"Time Correction", cParent:"Submit CSR Forms", cExec:"TimeCorrection();"});
app.addMenuItem({cName:"Technical Issue", cParent:"Submit CSR Forms", cExec:"TechDownTime();"});

var CSRFormsMenu = app.trustedFunction(function(){
  var csrRtn = app.popUpMenu("Time Correction","Technical Issue");
  if(csrRtn){
    if(csrRtn == "Time Correction"){
      TimeCorrection();
    }else if(csrRtn == "Technical Issue"){
      TechDownTime();
    }else{
      return;
    }
  }else return;
})


app.addToolButton({
    cName: "CSRForms",
    cLabel: "Send CSR Forms",
    oIcon: CustomerIcon,
    cEnable: "event.rc = (app.doc != null);",
    cExec: "CSRFormsMenu();"
});